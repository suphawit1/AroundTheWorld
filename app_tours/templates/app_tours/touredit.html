{% extends 'app_general/components/base.html'%}
{% block site_title%}tour |{% endblock site_title%}
{% load static %}
{% block link %}
    <link rel="stylesheet" href="{% static 'app_tour/nicepage.css' %}" media="screen">
    <link rel="stylesheet" href="{% static 'app_tour/edittour.css' %}" media="screen">
    <link id="u-theme-google-font" rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:100,100i,300,300i,400,400i,500,500i,700,700i,900,900i|Open+Sans:300,300i,400,400i,500,500i,600,600i,700,700i,800,800i">
    <link id="u-page-google-font" rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:100,100i,300,300i,400,400i,700,700i,900,900i">
{% endblock %}
{% block content%}
    <body data-path-to-root="./" class="u-body u-xl-mode" data-lang="en">
      {% csrf_token %}
      <div id="tour-element" data-tour-url="{% url 'touredit' tour.TourName %}"></div>
        <section class="u-clearfix u-custom-color-7 u-section-1" id="sec-a06d">
          <div class="u-clearfix u-sheet u-sheet-1">
            <div class="custom-expanded u-container-style u-group u-white u-group-1">
              <div class="u-container-layout u-container-layout-1">
                <div class="u-border-2 u-border-grey-75 u-container-style u-group u-radius-15 u-shape-round u-white u-group-2">
                  <div class="u-container-layout u-container-layout-2">
                    <p class="u-text u-text-default u-text-1"><input class = "edithead" type="text" id="TourName" placeholder="ชื่อทัวร์">
                      <br><input class = "edithead" type="text" id="Tourtype" placeholder="ประเภททัวร์" style="margin-top: 10px;"><br>
                        <input class = "edithead" type="text" id="Duration" placeholder="ระยะเวลา" style="margin-top: 10px;">
                    </p>
                    <p class="u-text u-text-default u-text-2"><input class = "edithead" type="text" id="Tour" placeholder="ทัวร์" style="margin-top: 10px;">
                      <br><input class = "edithead" type="text" id="Country" placeholder="เที่ยวเมือง" style="margin-top: 10px;"></span>
                      <br>
                      <input class = "edithead" type="text" id="Airlines" placeholder="สายการบิน" style="margin-top: 10px;">
                    </p>
                      <input class = "edithead" type="text" id="Price" placeholder="ราคาเริ่มต้น(บาท)" style="margin-top: 10px; width: 450px;">
                      <br>
                    </h2>
                  </div>
                </div>
                <div class="u-border-2 u-border-grey-75 u-container-style u-group u-radius-15 u-shape-round u-white u-group-3">
                  <div class="u-container-layout u-container-layout-3">
                    <h2 class="u-text u-text-default u-text-4"> ไฮไลท์ทัวร์&nbsp;Highlight<br>
                    </h2>
                    <img class="u-image u-image-contain u-image-default u-preserve-proportions u-image-1" src="{% static 'app_tour/highlight.png' %}" alt="" data-image-width="256" data-image-height="256">
                    <p class="u-text u-text-5"> <input class = "edithead" type="text" id="Highlight" placeholder="ใส่สถานที่ Highlight" style="margin-top: 10px; width: 450px;"></p>
                  </div>
                </div>
                <img class="u-image u-image-contain u-image-default u-preserve-proportions u-image-2" src="{{tour.immage.url}}" alt="" data-image-width="2245" data-image-height="1587">
                <h4>ใส่/เปลื่ยน รูปภาพ</h4>
                <form method="post" enctype="multipart/form-data">
                  {% csrf_token %}
                  <input type="file" name="file">
                  <button type="submit">Upload</button>
                </form>
              </div>
            </div>
          </div>
        </section>
        <section class="u-clearfix u-custom-color-7 u-section-2" id="sec-783d">
          <div class="u-clearfix u-sheet u-sheet-1">
            <div class="custom-expanded u-container-style u-group u-white u-group-1">
              <div class="u-container-layout u-container-layout-1" >
                <img class="u-image u-image-default u-preserve-proportions u-image-1" src="{% static 'app_tour/description.png' %}" alt="" data-image-width="256" data-image-height="256">
                <h2 class="u-text u-text-default u-text-1"> รายละเอียดการท่องเที่ยว<br></h2>
                <div id = "container">
                </div>
                
                <div id = "AddHeaderDetail" style="top: 44px; left: 0px; cursor: pointer; width: 130px; margin-left: 24px;">
                  <div class="u-custom-color-5 u-preserve-proportions u-shape u-shape-circle u-shape-1">
                    <h2 class="u-text u-text-body-alt-color u-text-2" style="font-size: 80px; top: -11px; left: -24px;">+</h2>
                  </div>
                </div>
                
                <img src="{% static 'app_tour/add-button.svg' %}" id = "add-time" style="width: 40px; height: 40px; margin-top: 10px; margin-left: 150px; cursor: pointer;">
                <img src="{% static 'app_tour/add-button.svg' %}" id = "add-detail" style="width: 40px; height: 40px; margin-top: 10px; margin-left: 300px; cursor: pointer;">
                <img src="{% static 'app_tour/undo-button.png' %}" id = "undo" style="width: 40px; height: 40px; margin-top: 10px; margin-left: 450px; cursor: pointer;">
                <p><h6 style="display: inline; margin-left: 10px;">เพิ่มรายละเอียดวัน</h6><h6 style="display: inline; top: -25px">เพิ่ม Timestamp ในวัน</h6>
                  <h6 style="display: inline; margin-left: 150px;">เพิ่มรายละเอียด</h6><h6 style="display: inline; margin-left: 390px;">ลบแถวล่าสุด</h6></p>
                <p><button id = "Submit" style="margin-left: 500px;">Submit</button></p>
              </div>
            </div>
          </div>
        </section>
        <section class="u-clearfix u-custom-color-7 u-section-3" id="sec-2810">
          <div class="u-clearfix u-sheet u-sheet-1">
            <div class="u-container-style u-expanded-width u-group u-white u-group-1">
              <div class="u-container-layout u-container-layout-1">
                <img class="u-image u-image-default u-preserve-proportions u-image-1" src="{% static 'app_tour/condition.png' %}" alt="" data-image-width="256" data-image-height="256">
                <h2 class="u-text u-text-default u-text-1"> รายละเอียดและเงื่อนไข<br>
                </h2>
                <p class="u-heading-font u-text u-text-default u-text-2"> เงื่อนไขการให้บริการ<br>► การจองทัวร์และชำระค่าบริการ&nbsp;<br>- กรุณาชำระเงินค่ามำจำทัวร์ 10,000 บาท/ท่าน &nbsp;โดยโอนเข้าบัญชี ที่นั่งจะยืนยันเมื่อได้รับเงินแล้วเท่านั้น<br>- ชำระค่าทัวร์ส่วนที่เหลือ 21 วัน ก่อนการเดินทาง 21 วัน &nbsp;กรณีวันเดินทางน้อยกว่า 21 วัน หรือราคาทัวร์โปรโมชั่น ต้องชำระค่าทัวร์เต็มจำนวนเท่านั้น&nbsp;<br>- กรุณาส่งสำเนาหน้าพาสปอร์ตและเอกสารรับรองการฉีดวัคซีนครบถ้วน Vaccinated Certificate และ International Vaccinated Certificate (จากแอปหมอพร้อม) พร้อมเอกสารชำระมัดจำค่าทัวร์<br>**สำคัญ**สำเนาหน้าพาสปอร์ตผู้เดินทาง (จะต้องมีอายุเหลือมากกว่า 6 เดือนก่อนหมดอายุนับจากวันเดินทางไป-กลับและจำนวนหน้หนังสือเดินทางต้องเหลือว่างสำหรับติดวีซ่าไม่ต่ำกว่า 3หน้า) **กรุณาตรวจสอบก่อนส่งให้บริษัทมิฉะนั้นทางบริษัทจะไม่รับผิดชอบกรณีพาสปอร์ตหมดอายุ ** กรุณาส่งพร้อมพร้อมหลักฐานการโอนเงินมัดจำการยกเลิกการเดินทาง<br>***เงื่อนไขการยกเลิกทัวร์เป็นไปตามพระราชบัญญัติธุรกิจนำเที่ยวและมัคคุเทศก์***<br>1. แจ้งยกเลิกการเดินทางล่วงหน้า ไม่น้อยกว่า 30 วัน คืนเงินค่าทัวร์โดยหักค่าใช้จ่ายที่เกิดขึ้นจริง<br>2. แจ้งยกเลิกก่อนการเดินทาง 15-29 วัน ยึดเงิน 50% จากยอดที่ลูกค้าชำระมา ส่วนที่เหลือ 50% หัก ค่าใช้จ่ายที่เกิดขึ้นจริง (ถ้ามี)<br>3. แจ้งยกเลิกการเดินทางน้อยกว่า 15 วันของการเดินทาง ขอสงวนสิทธิ์ไม่คืนเงินทั้งหมด<br>** กรณีมีเหตุให้ยกเลิกทัวร์ โดยไม่ใช่ความผิดของบริษัททัวร์ ทางบริษัทคืนเงินค่าทัวร์โดยหักค่าใช้จ่ายที่เกิดขึ้นจริง(ถ้ามี)&nbsp;<br>*ค่าใช้จ่ายที่เกิดขึ้นจริง เช่น ค่ามัดจำตั๋วเครื่องบิน โรงแรม ค่าวีซ่า และค่าใช้จ่ายจำเป็นอื่นๆ<br>
                  <br>หมายเหตุ : กรุณาอ่านศึกษารายละเอียดทั้งหมดก่อนทำการจอง เพื่อความถูกต้องและความเข้าใจตรงกันระหว่างท่านลูกค้าและบริษัท ฯ และเมื่อท่านตกลงชำระเงินมัดจาหรือค่าทัวร์ทั้งหมดกับทางบริษัทฯ แล้ว ทางบริษัทฯ จะถือว่าท่านได้ยอมรับเงื่อนไขข้อตกลงต่างๆ ทั้งหมด&nbsp;<br>- การเดินทางในแต่ละครั้งจะต้องมีผู้โดยสารขั้นต่ำ 20 ท่าน<br>- ขอสงวนสิทธิ์การเก็บค่าน้ำมันและภาษีสนามบินทุกแห่งเพิ่ม หากสายการบินมีการปรับขึ้นก่อนวันเดินทาง&nbsp;<br>- บริษัทฯ ขอสงวนสิทธิ์ในการเปลี่ยนเที่ยวบิน โดยมิต้องแจ้งให้ทราบล่วงหน้าอันเนื่องจากสาเหตุต่างๆ<br>- บริษัทฯ มีสิทธิ์ที่จะเปลี่ยนแปลงรายละเอียดบางประการในทัวร์นี้ เมื่อเกิดเหตุสุดวิสัยไม่อาจแก้ไขได้<br>- บริษัทฯ ไม่รับผิดชอบค่าเสียหายในเหตุการณ์ที่เกิดจากยานพาหนะ การยกเลิกเที่ยวบิน การล่าช้าของสายการบิน ภัยธรรมชาติ การเมือง จลาจล ประท้วง คำสั่งของเจ้าหน้าที่รัฐ และอื่นๆ ที่อยู่นอกเหนือการควบคุมของทางบริษัท หรือค่าใช่จ่ายเพิ่มเติมที่เกิดขึ้นทางตรง หรือทางอ้อม เช่น การเจ็บป่วย การถูกทำร้าย การสูญหาย ความล่าช้า หรือจากอุบัติเหตุต่างๆ<br>- มัคคุเทศก์ พนักงาน และตัวแทนบริษัทฯ ไม่มีสิทธิ์ในการให้คำสัญญาใดๆ ทั้งสิ้นแทน บริษัทฯนอกจากมีเอกสารลงนามโดยผู้มีอำนาจของบริษัทฯกำกับเท่านั้น<br>- ราคาดังกล่าวข้างต้นสามารถเปลี่ยนแปลงได้ตามความเหมาะสม ทั้งนี้ขึ้นอยู่ตามสภาวะค่าเงินบาทและค่าน้ำมันที่ไม่คงที่ การปรับราคาค่าโดยสารของสายการบิน เพิ่มเติมจากราคาที่กำหนดไว้<br>- เมื่อท่านออกเดินทางไปกับคณะแล้ว ท่านงดใช้บริการใดบริการหนึ่ง หรือไม่เดินทางพร้อมคณะ ถือว่าท่านสละสิทธิ์ ไม่สามารถเรียกร้องค่าบริการคืนได้ ไม่ว่ากรณีใดๆ ทั้งสิ้น
                </p>
              </div>
            </div>
          </div>
        </section>
    </body>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
  const createHeaderDeatailButton = document.getElementById('AddHeaderDetail');
  const createtimeButton = document.getElementById('add-time');
  const createdetailButton = document.getElementById('add-detail');
  const redoButton = document.getElementById('undo');
  const submitButton = document.getElementById('Submit');
  const container = document.getElementById('container');
  var tourElement = document.getElementById('tour-element');
  var tourUrl = tourElement.dataset.tourUrl;

  var head = 0;
  var time = 0;
  var detail = 0;
  
  let mydivList = [];

  // Function to create a new element and append it to the container
  function createNewElementHead() {
    head++;
    time = 0;
    detail = 0;
    const headElement = document.createElement('div');
    headElement.className = 'Headerdate';
    headElement.id = 'he'+head;
    headElement.innerHTML = '<input class="editdetail" type="text" id="datecircle'+head+'" placeholder="วันที่" style="margin-top: 10px; width: 60px; color: red;">\
    <input class="editdetail" type="text" id="datedetail'+head+'" placeholder="หัวเรื่องของวัน" style="margin-top: 10px; width: 940px; color: red;">';
    mydivList.push(headElement);

    container.appendChild(headElement);
  }
  function createNewElementtimedetail() {
    time++;
    detail = 0;
    const timeElement = document.createElement('div');
    timeElement.className = 'time';
    timeElement.id = 'he'+head+'ti'+time;
    timeElement.innerHTML = '<input class="editdetail" type="text" id="indatedetail' +head+':'+ time + '" placeholder="เวลา" style="margin-top: 10px; margin-left: 65px; width: 60px;">\
    <input class="editdetail" type="text" id="indetail' +head+':'+ time + '" placeholder="รายละเอียด" style="margin-top: 10px; width: 935px; overflow-x: auto;">';
    mydivList.push(timeElement);

    container.appendChild(timeElement);
  }
  function createNewElementdetail() {
    detail++;
    const detailElement = document.createElement('div');
    detailElement.className = 'detail';
    detailElement.id = 'he'+head+'ti'+time+'de'+detail;
    detailElement.innerHTML = '<input class = "editdetail" type="text" id="detail'+head+':'+ time +':'+detail+'" placeholder="รายละเอียด" style="margin-top: 10px; margin-left: 130px; width: 935px; overflow: auto;">';
    
    mydivList.push(detailElement);

    container.appendChild(detailElement);
  }
  function redotheElement(){
    container.removeChild(mydivList[mydivList.length - 1]);
    var removedElement = mydivList.pop();
    if (removedElement.className == 'detail'){
      detail--;
    }else if (removedElement.className == 'time'){
      if (mydivList[mydivList.length - 1].className == "detail"){
        let idString = mydivList[mydivList.length - 1].id;
        let iddetail = idString.split('de');
        detail = iddetail[1]
      }
      time--;
    }else if (removedElement.className == 'Headerdate'){
      if (head == 1){
        head = 1;
      }else if (mydivList[mydivList.length - 1].className == "detail"){
        let idString = mydivList[mydivList.length - 1].id;
        let iddetail = idString.split('de');
        let idtime = iddetail[0].split('ti');
        console.log(iddetail[1],idtime[1]);
        time = idtime[1];
        detail = iddetail[1];
      }else if(mydivList[mydivList.length - 1].className == "time"){
        let idString = mydivList[mydivList.length - 1].id;
        let idtime = idString[0].split('ti');
        time = idtime[1];
        detail = 0;
      }
      head--;
    }
  }
  function submit(){
    var tour = document.getElementById("Tour");
    var TourName = document.getElementById("TourName");
    var Country = document.getElementById("Country");
    var Tourtype = document.getElementById("Tourtype");
    var Airlines = document.getElementById("Airlines");
    var Duration = document.getElementById("Duration");
    var Price = document.getElementById("Price");
    var Highlight = document.getElementById("Highlight");

    const basedatecircle = 'datecircle';
    const basedatedetail = 'datedetail';
    const basedetail = 'detail';
    let counter = 1;
    const datecircle = [];
    const datedetail = [];
    let indatedetail = [];
    let indetail = [];
    let detail = [];
    let timesdetail = [];
    let timesdetailcom = [];
    let detailcom = [];
    var datatosent = ""

    var Head = tour.value+",,"+TourName.value+",,"+Country.value+",,"+Tourtype.value+",,"+Airlines.value+",,"+Duration.value+",,"+Price.value+",,"+Highlight.value+"<<Head>>"


    while (document.getElementById(`${basedatecircle}${counter}`)) {
      const element = document.getElementById(`${basedatecircle}${counter}`);
      datecircle.push(element.value);
      counter++;
    }
    counter = 1;
    while (document.getElementById(`${basedatedetail}${counter}`)) {
      const element = document.getElementById(`${basedatedetail}${counter}`);
      datedetail.push(element.value);
      counter++;
    }
    counter = 1;
    var numHead = datecircle.length;
    var textDay = ""
    for (var i = 0; i < numHead; i++) {
      textDay += datecircle[i]+",,"+datedetail[i]
      if (i < numHead-1){
        textDay += "||"
      }else{
        textDay += "<<Day>>"
      }
    }
    var timedetail = ""
    for (var i = 1; i <= numHead; i++) {
      counter = 1;
      var baseindatedetail = 'indatedetail'+i+":";
      var baseindetail = 'indetail'+i+":";
      while (document.getElementById(`${baseindatedetail}${counter}`)) {
      const element = document.getElementById(`${baseindatedetail}${counter}`);
      indatedetail.push(element.value);
      counter++;
    }
    counter = 1;
    while (document.getElementById(`${baseindetail}${counter}`)) {
      const element = document.getElementById(`${baseindetail}${counter}`);
      indetail.push(element.value);
      counter++;
    }
    var numDate = indatedetail.length;
    
    for (var j = 1; j <= numDate; j++) {
      counter = 1;
      const basedetail = 'detail'+i+":"+j+":";
      detail.push(indetail[j-1]);
      while (document.getElementById(`${basedetail}${counter}`)) {
      const element = document.getElementById(`${basedetail}${counter}`);
      detail.push(element.value);
      counter++;
      }
      timesdetail.push(indatedetail[j-1]);
      timesdetail.push(detail);
      timesdetailcom.push(timesdetail);
      timesdetail = [];
      detail = [];
    }
    detailcom.push(timesdetailcom)
    timesdetailcom = [];
    indatedetail = [];
    indetail = [];

    datatosent = Head+textDay
    var jsonString = JSON.stringify(detailcom);
  }
  datatosent+=jsonString
  function getCookie(name) {
    var cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        var cookies = document.cookie.split(';');
        for (var i = 0; i < cookies.length; i++) {
            var cookie = cookies[i].trim();
            // Does this cookie string begin with the name we want?
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
  var csrftoken = getCookie('csrftoken');
  $.ajax({
    type: "POST", // Use POST or GET based on your requirements
    url: tourUrl, // Replace with the URL of your Django view
    data: {
        data: datatosent,
        csrfmiddlewaretoken: csrftoken
    },
    success: function(response) {
        console.log("Data sent successfully!"); // Handle the response from the server if needed
        window.location.href = "{% url 'tour' tour.TourName %}"
    },
    error: function(error) {
        console.error("Error:", error); // Handle errors if the request fails
    }
  });
}

  

  createHeaderDeatailButton.addEventListener('click', createNewElementHead);
  createtimeButton.addEventListener('click', createNewElementtimedetail);
  createdetailButton.addEventListener('click', createNewElementdetail);
  redoButton.addEventListener('click', redotheElement);
  submitButton.addEventListener('click', submit);
  
</script>
    {% endblock content%}
  </html>

