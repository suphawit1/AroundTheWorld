{% extends 'app_general/components/base.html'%}
{% block content%}
    <form id="myForm" method="post">
        <h1>Payment</h1>
        <label for="choice">โปรดเลือกวิธีการชำระเงิน:</label>
            <input type="radio" id="option1" name="options">
            <label for="option1">ชำระเงินด้วยบัตรเครดิต</label>

            <input type="radio" id="option2" name="options">
            <label for="option2">ชำระด้วยเงินในระบบ</label>
            
        {% csrf_token %}
        <div id="div1" style="display: none;">
            <h3>ชำระเงินด้วยบัตรเครดิต</h3>
            <p> {{form.Name.label}}: {{form.Name}}</p>
            <p> {{form.CreditCard.label}}: {{form.CreditCard}}</p>
            <p> {{form.CVV.label}}: {{form.CVV}} หมดอายุ(เดือน/ปี): {{form.exmonth}} / {{form.exyear}}</p>
        </div>
        <div id="div2" style="display: none;">
            <h3>ชำระด้วยเงินในระบบ</h3>
            <p>ยอดเงินในระบบ: {{cus.Credits|floatformat:'g'}} บาท</p>
            <p>ราคา: {{payment.Amount|floatformat:'g'}} บาท</p>
            <p id="result"></p>

        </div>
        <div style="background-color: rgb(175, 175, 175); width: 200px;">
            <p>{{payment.Amount}} บาท</p>
            <p>โปรดชำระภายใน</p><div id="countdown"></div>
            <p><button type = "submit" id="submitButton">จ่าย</button></p>
        </div>
        
    </form>


<script>
    const option1Radio = document.getElementById("option1");
    const option2Radio = document.getElementById("option2");
    const div1 = document.getElementById("div1");
    const div2 = document.getElementById("div2");
    const nameField = document.getElementById('name');
    const CardField = document.getElementById('card');
    const CVVField = document.getElementById('CVV');
    const exmonthField = document.getElementById('exmonth');
    const exyearField = document.getElementById('card');

    var form = document.getElementById("myForm");
    var submitButton = document.getElementById("submitButton");

    var cusCredits = "{{ cus.Credits }}";
    var paymentAmount = "{{ payment.Amount }}";
    var result = cusCredits - paymentAmount;
    var formattedNumber = addCommasToInteger(result);
    document.getElementById("result").innerHTML = "คงเหลือ " + formattedNumber + " บาท";

    option1Radio.addEventListener("change", () => {
        if (option1Radio.checked) {
            div1.style.display = "block";
            div2.style.display = "none";
        }
    });

    option2Radio.addEventListener("change", () => {
        if (option2Radio.checked) {
            div1.style.display = "none";
            div2.style.display = "block";
        }
    });
    submitButton.addEventListener("click", function() {
        if (option2Radio.checked){
            if (result < 0){
                alert("ยอดเงินของคุณไม่เพียงพอโปรดเติมเงิน หรือ เลือกวิธีการชำระเงินด้วยวิธีการอื่น")
            }else{
                nameField.value = 'IMUSING CREDIT';
                CardField.value = '0000000000000000';
                CVVField.value = '000';
                exmonthField.value = '1';
                exyearField.value = '2023'
                form.submit();
            }
        }
        });
    // Set the target date and time for the countdown (assuming booktime is correctly parsed)
    var inputDateStr = "{{book.BookTime}}";

    // Define a mapping for Thai month names to English month names
    var thaiMonthMap = {
    "มกราคม": "01",
    "กุมภาพันธ์": "02",
    "มีนาคม": "03",
    "เมษายน": "04",
    "พฤษภาคม": "05",
    "มิถุนายน": "06",
    "กรกฎาคม": "07",
    "สิงหาคม": "08",
    "กันยายน": "09",
    "ตุลาคม": "10",
    "พฤศจิกายน": "11",
    "ธันวาคม": "12"
    };

    // Split the input string into date and time parts
    var parts = inputDateStr.split(", ");

    // Extract the Thai month name
    var thaiMonth = parts[0].split(" ")[1];

    // Map the Thai month name to the English month name
    var englishMonth = thaiMonthMap[thaiMonth];

    // Extract the day and year
    var dayAndYear = parts[0].split(" ");
    var day = parseInt(dayAndYear[0]);
    var year = parseInt(dayAndYear[2]);

    // Extract the time
    var time = parts[1];

    // Create a formatted date string in English format
    var formattedDateStr = year+ "-" +englishMonth + "-" + day + "T" + time+"Z";

    // Create a JavaScript Date object from the formatted date string
    var formattedDate = new Date(formattedDateStr);

    
    // Set the target date and time for the countdown (assuming booktime is correctly parsed)
    var booktime = new Date(formattedDateStr).getTime();
    var oneDayMilliseconds = 24 * 60 * 60 * 1000;
    var targetDate = booktime + oneDayMilliseconds;

    // Update the countdown every second
    var countdown = setInterval(function() {
        var currentDate = new Date().getTime();
        var timeLeft = targetDate - currentDate;

        // Calculate days, hours, minutes, and seconds
        var days = Math.floor(timeLeft / (1000 * 60 * 60 * 24));
        var hours = Math.floor((timeLeft % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        var minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
        var seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);

        // Display the countdown on your HTML element
        document.getElementById("countdown").innerHTML = hours + "ชั่วโมง. " + minutes + "นาที.";

        // If the countdown reaches zero, do something (e.g., show a message)
        if (timeLeft < 0) {
            clearInterval(countdown);
            document.getElementById("countdown").innerHTML = "Countdown expired!";
        }
    }, 60000); // Update every 1 second (1000 milliseconds)
    function addCommasToInteger(number) {
        return number.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    }
</script>
{% endblock content%}